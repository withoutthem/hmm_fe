#!/usr/bin/env bash
# =====================================================================
# Husky pre-push hook (FE ì „ìš© ë ˆí¬)
# - FE: build:dev ê°•ì œ
# =====================================================================

. "$(dirname "$0")/husky.sh"
set -euo pipefail

# --------------------------- Helpers ---------------------------------
CYN='\033[36m'; GRN='\033[32m'; YLW='\033[33m'; RED='\033[31m'; MAG='\033[35m'; NC='\033[0m'
log()   { printf "${CYN}%s${NC}\n" "$*"; }
ok()    { printf "âœ… ${GRN}%s${NC}\n" "$*"; }
warn()  { printf "âš ï¸  ${YLW}%s${NC}\n" "$*"; }
fail()  { printf "âŒ ${RED}%s${NC}\n" "$*" >&2; exit 1; }
divider(){ printf "\n${MAG}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n\n"; }

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

divider
log "ğŸš€ pre-push ì‹œì‘: Frontend ê°œë°œ ë¹Œë“œ ê²€ì¦"

# ------------------------ FE: build:dev -------------------------------
divider
log "ğŸ§± [Step 1] Frontend ê°œë°œ ë¹Œë“œ (build:dev)"

# (ìˆ˜ì •ë¨) frontend í´ë”ë¡œ ì´ë™í•˜ì—¬ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
cd "$REPO_ROOT/frontend" || fail "frontend ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

[ -f "package.json" ] || fail "frontend/package.json ì´ ì—†ìŠµë‹ˆë‹¤."

if command -v npm >/dev/null 2>&1; then
  log "ğŸ“¦ npm ci (ì—†ìœ¼ë©´ npm i)â€¦"
  if [ -f "package-lock.json" ]; then
    # npm ciëŠ” ì¶œë ¥ì´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë§Œ í™•ì¸
    if ! npm ci --prefer-offline --no-audit --progress=false >/dev/null 2>&1; then
        log "npm ci ì‹¤íŒ¨. npm installë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤..."
        npm install || fail "npm install ì‹¤íŒ¨"
    fi
  else
    npm install || fail "npm install ì‹¤íŒ¨"
  fi
else
  fail "npm ë¯¸ì„¤ì¹˜ë¡œ FE ë¹Œë“œë¥¼ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
fi

# package.jsonì— build:dev ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
node -e "const p=require('./package.json'); process.exit(p?.scripts?.['build:dev']?0:1)" \
  || fail "frontend/package.jsonì— scripts.build:dev ê°€ ì—†ìŠµë‹ˆë‹¤."

FE_CMD="npm run build:dev"
log "ğŸ— ì‹¤í–‰: ${FE_CMD}"
sh -c "${FE_CMD}" || fail "Frontend ê°œë°œ ë¹Œë“œ ì‹¤íŒ¨ â†’ push ì¤‘ë‹¨"

ok "Frontend ê°œë°œ ë¹Œë“œ í†µê³¼"
divider
ok "ğŸ‰ğŸ‰ğŸ‰ [pre-push] FE ëª¨ë“  ë¹Œë“œ í†µê³¼(dev) ğŸ‰ğŸ‰ğŸ‰ â†’ push ì§„í–‰"
