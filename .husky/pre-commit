#!/bin/sh
# =====================================================================
# Husky pre-commit hook (FE ì „ìš© ë ˆí¬)
# - FE: lint-staged â†’ TS íƒ€ì…ì²´í¬ â†’ Jest
# =====================================================================

. "$(dirname "$0")/husky.sh"
set -euo pipefail

# --------------------------- Helpers ---------------------------------
log()   { printf "\033[36m%s\033[0m\n" "$*"; }
ok()    { printf "âœ… \033[32m%s\033[0m\n" "$*"; }
warn()  { printf "âš ï¸  \033[33m%s\033[0m\n" "$*"; }
fail()  { printf "âŒ \033[31m%s\033[0m\n" "$*" >&2; exit 1; }
error() { printf "âŒ \033[31m%s\033[0m\n" "$*" >&2; }
divider(){ printf "\n\033[35mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n\n"; }

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

divider
log "ğŸš€ Husky pre-commit Hook ì‹œì‘"

# ------------------------ Step 1: FE lint -----------------------------
divider
log "ğŸ”§ [Step 1] lint-staged ì‹¤í–‰"
if command -v npx >/dev/null 2>&1; then
  npx lint-staged || fail "lint-staged ì‹¤íŒ¨ â†’ ì»¤ë°‹ ì°¨ë‹¨"
else
  warn "npxê°€ ì—†ì–´ lint-stagedë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
fi

# -------------------- Step 2: FE TypeScript ---------------------------
divider
log "ğŸ” [Step 2] TypeScript íƒ€ì…ì²´í¬(frontend)"
if [ -f "package.json" ]; then
  npm run typecheck || fail "TypeScript íƒ€ì…ì²´í¬ ì‹¤íŒ¨ â†’ ì»¤ë°‹ ì°¨ë‹¨"
else
  warn "package.jsonì´ ì—†ì–´ íƒ€ì…ì²´í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
fi

# ----------------------- Step 3: FE Tests -----------------------------
divider
log "ğŸ§ª [Step 3] Jest í…ŒìŠ¤íŠ¸(frontend)"
if [ -f "package.json" ]; then
  npm run test || fail "Jest í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ â†’ ì»¤ë°‹ ì°¨ë‹¨"
else
  warn "package.jsonì´ ì—†ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
fi

divider
ok "ğŸ‰ğŸ‰ğŸ‰ [pre-commit] ëª¨ë“  ê²€ì‚¬ í†µê³¼ ğŸ‰ğŸ‰ğŸ‰"
divider