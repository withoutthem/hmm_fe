<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <title>HMM E-Service</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
        html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
        img.bg { width:100vw; height:100vh; object-fit:contain; display:block; }

        .chatbotui_box {
            position: fixed; bottom:20px; right:20px; z-index:9999;
            width:64px; height:64px; border-radius:50%;
            box-shadow:0 8px 24px rgba(0,0,0,.2);
            overflow:hidden; background:#fff;
            transition: width .3s ease, height .3s ease, border-radius .25s ease, box-shadow .2s ease;
        }
        .chatbotui_box.is-open { width:min(450px); height:min(775px); border-radius:16px; }
        .chatbotui_box.is-open:hover { box-shadow:0 12px 32px rgba(0,0,0,.28); }

        .chatbotui_fab { position:absolute; inset:0; display:grid; place-items:center;
            border:0; background:#1f6fff; color:#fff; cursor:pointer;
            width:100%; height:100%; font-size:20px; border-radius:inherit; transition:transform .1s ease;
        }
        .chatbotui_fab:active { transform:scale(.97) }
        .chatbotui_box.is-open .chatbotui_fab { display:none; }
        .chatbotui_box.is-open .chatbotui_header { display:flex; height:68px; top:0px; z-index:1; position: absolute; left:55px; width: 300px;}
        .chatbotui_framewrap { position:absolute; inset:0 0 0 0; display:none; background:#fff; }
        .chatbotui_box.is-open .chatbotui_framewrap { display:block; }
        #chatbotui { width:100%; height:100%; border:0; background:#fff; }

        /* ë‹«í˜ ìƒíƒœì—ì„œëŠ” í•­ìƒ ìš°í•˜ë‹¨ ê³ ì • */
        .chatbotui_box:not(.is-open) {
            bottom:20px !important; right:20px !important; top:auto !important; left:auto !important;
        }

        /* íˆ¬ëª… ë“œë˜ê·¸ í•¸ë“¤ëŸ¬(ì˜¤ë²„ë ˆì´) */
        .chatbotui_drag_handle{
            position: absolute;
            inset: 0;                 /* ë°•ìŠ¤ ì „ì²´ë¥¼ ë®ìŒ */
            display: none;            /* í‰ì†Œì—” ìˆ¨ê¹€ */
            cursor: move;
            background: transparent;  /* íˆ¬ëª… */
            z-index: 2;
        }

    </style>
</head>
<body>
<img class="bg" src="./eservice.png" alt="e-service" />

<div id="chatbot-box" class="chatbotui_box" aria-expanded="false" aria-haspopup="dialog">
    <div id="chatbot-drag-overlay" class="chatbotui_drag_handle" aria-hidden="true"></div>

    <button id="chatbot-fab" class="chatbotui_fab" aria-label="Open chat">ğŸ’¬</button>

    <div class="chatbotui_header" role="toolbar" id="outer-header">
    </div>

    <div class="chatbotui_framewrap">
        <iframe id="chatbotui" src="http://localhost:5173" title="HMM Chatbot"></iframe>
    </div>
</div>


<script>
    (function($){
        const $box = $('#chatbot-box');
        const $fab = $('#chatbot-fab');
        const $close = $('#chatbot-close');
        const $overlay = $('#chatbot-drag-overlay');
        const iframe = document.getElementById('chatbotui');

        let open = false;

        function restoreFabAnchor(){
            $box.css({ top:'', left:'', bottom:'20px', right:'20px' });
        }
        function openChat(){
            if (open) return; open = true;
            $box.addClass('is-open').attr('aria-expanded','true');
        }
        function closeChat(){
            if (!open) return; open = false;
            $box.removeClass('is-open').attr('aria-expanded','false');
            restoreFabAnchor();
            hideOverlay();
        }

        $fab.on('click', openChat);
        $close.on('click', closeChat);

        // jQuery UI draggable â€” íˆ¬ëª… ì˜¤ë²„ë ˆì´ë¥¼ handleë¡œ ì‚¬ìš©
        $box.draggable({
            handle: '#chatbot-drag-overlay',
            containment: 'window',
            start: () => {
                // ë“œë˜ê·¸ ì¤‘ iframe í¬ì¸í„° ì°¨ë‹¨ (ì„ íƒì‚¬í•­)
                if (iframe) iframe.style.pointerEvents = 'none';
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'move';
            },
            stop: () => {
                if (iframe) iframe.style.pointerEvents = '';
                document.body.style.userSelect = '';
                document.body.style.cursor = '';
                hideOverlay();
            }
        });

        function showOverlay(){
            $overlay.css('display','block');
        }
        function hideOverlay(){
            $overlay.css('display','none');
        }

        // íŠ¹ì • ì¢Œí‘œì—ì„œ ë“œë˜ê·¸ë¥¼ "ì¦‰ì‹œ ì‹œì‘"ì‹œí‚¤ê¸° ìœ„í•´ synthetic mousedown ë°œìƒ
        function dispatchSyntheticMouseDown(target, clientX, clientY){
            const ev = new MouseEvent('mousedown', {
                bubbles: true, cancelable: true, view: window,
                clientX, clientY, button: 0
            });
            target.dispatchEvent(ev);
        }

        // ì™¸ë¶€(ë¶€ëª¨) í—¤ë”ì—ì„œ ì§ì ‘ ì‹œì‘ â€” ì˜¤ë²„ë ˆì´ë¥¼ ë³´ì´ê³  ê·¸ ìë¦¬ì—ì„œ mousedown ìœ„ì„
        const outerHeader = document.getElementById('outer-header');
        if (outerHeader){
            outerHeader.addEventListener('mousedown', (e) => {
                if (!$box.hasClass('is-open')) return;
                showOverlay();
                // ë°•ìŠ¤ì˜ í˜„ì¬ ìœ„ì¹˜ë¥¼ top/left ê¸°ì¤€ìœ¼ë¡œ ì „í™˜ (ìš°í•˜ë‹¨ ì•µì»¤ í•´ì œ)
                const rect = $box[0].getBoundingClientRect();
                $box.css({ top: rect.top + 'px', left: rect.left + 'px', right:'', bottom:'' });

                dispatchSyntheticMouseDown($overlay[0], e.clientX, e.clientY);
            });
        }

        // ===== iframe ë‚´ë¶€ í—¤ë”ì—ì„œ ì˜¤ëŠ” postMessage ì²˜ë¦¬ =====
        // { type:'chatbot-drag-from-inner', clientX, clientY }
        // { type:'chatbot-close' }
        window.addEventListener('message', (event) => {
            const data = event.data;
            if (!data || typeof data !== 'object') return;

            if (data.type === 'chatbot-close'){
                closeChat();
            }

        });

        // ì „ì—­ mouseup â€” í˜¹ì‹œ startë§Œ ë˜ê³  stopì´ ì•ˆ íƒ„ ê²½ìš° ì •ë¦¬
        window.addEventListener('mouseup', hideOverlay);
    })(jQuery);
</script>

</body>
</html>